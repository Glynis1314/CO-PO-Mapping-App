{% extends "base.html" %}
{% block title %}Roles & Access Control — Admin{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-3">{% include "components/sidebar_admin.html" %}</div>
  <div class="col-md-9">

    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h3 class="mb-0">Roles & Access Control</h3>
        <div class="text-muted small">Manage user roles, view permissions, and control access across the system.</div>
      </div>
      <div>
        <a class="btn btn-outline-secondary btn-sm" href="{% url 'admin_users' %}">Manage Users</a>
      </div>
    </div>

    <!-- Summary cards -->
    <div class="row g-3 mb-4">
      <div class="col-md-2"><div class="card p-3 shadow-sm"><div class="small text-muted">Total Users</div><div class="h4">{{ total }}</div></div></div>
      <div class="col-md-2"><div class="card p-3 shadow-sm"><div class="small text-muted">Admins</div><div class="h4">{{ admins }}</div></div></div>
      <div class="col-md-2"><div class="card p-3 shadow-sm"><div class="small text-muted">HODs</div><div class="h4">{{ hods }}</div></div></div>
      <div class="col-md-2"><div class="card p-3 shadow-sm"><div class="small text-muted">Teachers</div><div class="h4">{{ teachers }}</div></div></div>
      <div class="col-md-2"><div class="card p-3 shadow-sm"><div class="small text-muted">Inactive</div><div class="h4">{{ inactive }}</div></div></div>
    </div>

    <ul class="nav nav-tabs mb-3" id="rbacTabs" role="tablist">
      <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#overview" type="button">Role Overview</button></li>
      <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#userroles" type="button">User Roles</button></li>
      <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#matrix" type="button">Permissions Matrix</button></li>
    </ul>

    <div class="tab-content">
      <!-- Role overview -->
      <div class="tab-pane fade show active" id="overview">
        <div class="row g-3">
          {% for r_val, r_label, perms, user_count in role_perms_ordered %}
          <div class="col-md-4">
            <div class="card shadow-sm p-3 h-100">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <h6 class="mb-0">{{ r_label }}</h6>
                  <div class="small text-muted">{{ perms|length }} permissions</div>
                </div>
                <div><span class="badge bg-light text-primary">{{ user_count }} users</span></div>
              </div>
              <p class="small text-muted mb-2">Role description (short).</p>
              <div class="mt-2">
                {% for p in perms %}
                <span class="badge bg-light text-muted me-1">{{ p }}</span>
                {% empty %}
                <div class="text-muted small">No permissions configured.</div>
                {% endfor %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- User roles -->
      <div class="tab-pane fade" id="userroles">
        <div class="card shadow-sm mb-3">
          <div class="card-body p-0">
            <table class="table mb-0">
              <thead class="table-light"><tr><th>Name</th><th>Email</th><th>Role</th><th>Status</th><th>Joined</th><th>Actions</th></tr></thead>
              <tbody>
                {% for u in users %}
                <tr>
                  <td>{{ u.get_full_name|default:u.username }}</td>
                  <td>{{ u.email }}</td>
                  <td>
                    {% if u.profile %}
                      {% if u.profile.role == 'ADMIN' %}
                        <span class="badge bg-danger">{{ u.profile.get_role_display }}</span>
                      {% elif u.profile.role == 'HOD' %}
                        <span class="badge bg-info">{{ u.profile.get_role_display }}</span>
                      {% else %}
                        <span class="badge bg-success">{{ u.profile.get_role_display }}</span>
                      {% endif %}
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                  <td>{% if u.is_active %}<span class="badge bg-success">Active</span>{% else %}<span class="badge bg-secondary">Inactive</span>{% endif %}</td>
                  <td>{{ u.date_joined|date:"j M Y" }}</td>
                  <td>
                    <a class="btn btn-sm btn-outline-primary" href="{% url 'admin_edit_user' u.pk %}">Change Role</a>
                    {% if u.is_active %}
                      <form class="d-inline" method="post" action="{% url 'admin_toggle_user_active' u.pk %}">{% csrf_token %}<button class="btn btn-link btn-sm text-danger">Deactivate</button></form>
                    {% else %}
                      <form class="d-inline" method="post" action="{% url 'admin_toggle_user_active' u.pk %}">{% csrf_token %}<button class="btn btn-link btn-sm text-success">Activate</button></form>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Permissions matrix -->
      <div class="tab-pane fade" id="matrix">
        <div class="d-flex justify-content-end mb-2">
          {% for r_val, r_label in roles %}
            <button class="btn btn-outline-secondary btn-sm ms-2" data-bs-toggle="modal" data-bs-target="#editRoleModal{{ r_val }}">Edit {{ r_label }}</button>
          {% endfor %}
        </div>

        <div class="card shadow-sm">
          <div class="table-responsive">
            <table class="table mb-0 align-middle">
              <thead class="table-light"><tr><th>Permission</th>{% for r_val, r_label in roles %}<th class="text-center">{{ r_label }}</th>{% endfor %}</tr></thead>
              <tbody>
                {% for row in matrix %}
                <tr>
                  <td><code class="small text-muted">{{ row.permission }}</code></td>
                  {% for val in row.values %}
                    <td class="text-center">{% if val %}<i class="bi bi-check-circle-fill text-success"></i>{% else %}<span class="text-muted">—</span>{% endif %}</td>
                  {% endfor %}
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Edit role modals -->
        {% for r_val, r_label, perms, user_count in role_perms_ordered %}
        <div class="modal fade" id="editRoleModal{{ r_val }}" tabindex="-1">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <form method="post" action="{% url 'admin_update_role_permissions' r_val %}">
                {% csrf_token %}
                <input type="hidden" name="all_permissions" value="" />
                <div class="modal-header"><h6 class="modal-title">Edit {{ r_label }} permissions</h6><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                  <div class="row g-2">
                    {% for row in matrix %}
                    <div class="col-md-6">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="permissions" id="perm_{{ r_val }}_{{ forloop.counter0 }}" value="{{ row.permission }}" {% if row.permission in perms %}checked{% endif %}>
                        <label class="form-check-label" for="perm_{{ r_val }}_{{ forloop.counter0 }}"><code>{{ row.permission }}</code></label>
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn btn-primary btn-sm">Save</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        {% endfor %}

      </div>
    </div>

  </div>
</div>

{% block extra_js %}
<script>
// When submitting role edit form, also add hidden inputs with all permissions so backend can iterate
document.querySelectorAll('form[action*="admin_update_role_permissions"]').forEach(form => {
  form.addEventListener('submit', e => {
    // remove existing all_permissions inputs
    form.querySelectorAll('input[name="all_permissions"]').forEach(i => i.remove());
    const perms = Array.from(form.querySelectorAll('input[name="permissions"]')).map(i => i.value);
    perms.forEach(p => {
      const hidden = document.createElement('input');
      hidden.type = 'hidden'; hidden.name = 'all_permissions'; hidden.value = p;
      form.appendChild(hidden);
    });
  });
});
</script>
{% endblock %}

{% endblock %}