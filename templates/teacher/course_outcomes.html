{% extends "base.html" %}
{% block title %}Course Outcomes – {{ course.code }} — DBIT Attainment{% endblock %}

{% block sidebar %}{% include "components/sidebar_teacher.html" %}{% endblock %}

{% block content %}
<div class="container-main-offset">
<div class="container py-4">

  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'teacher_dashboard' %}">Dashboard</a></li>
      <li class="breadcrumb-item"><a href="{% url 'course_overview' course.id %}">{{ course.code }}</a></li>
      <li class="breadcrumb-item active">Course Outcomes</li>
    </ol>
  </nav>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0"><i class="bi bi-bullseye me-2"></i>Course Outcomes — {{ course.code }}</h4>
    {% if not locked %}
      <button class="btn btn-sm btn-primary" id="btnAddCO" data-bs-toggle="modal" data-bs-target="#coModal">
        <i class="bi bi-plus-lg me-1"></i> Add CO
      </button>
    {% else %}
      <span class="badge bg-danger"><i class="bi bi-lock-fill"></i> Semester Locked</span>
    {% endif %}
  </div>

  {% if messages %}
    {% for msg in messages %}
      <div class="alert alert-{{ msg.tags }} alert-dismissible fade show" role="alert">
        {{ msg }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- CO list -->
  <div class="row g-3">
    {% for co in cos %}
    <div class="col-12">
      <div class="card">
        <div class="card-body d-flex justify-content-between align-items-start gap-3">
          <div class="flex-grow-1">
            <div class="d-flex align-items-center mb-2">
              <span class="badge bg-primary me-3">{{ co.code }}</span>
              <div class="fw-semibold">{{ co.description }}</div>
            </div>
            <div class="mt-2">
              {% if co.bloom_levels %}
                {% for bloom in bloom_choices %}
                  {% if bloom in co.bloom_levels %}
                    <span class="badge bg-secondary me-1">L{{ forloop.counter }} &nbsp; {{ bloom }}</span>
                  {% endif %}
                {% endfor %}
              {% else %}
                <span class="text-muted">No Bloom level selected</span>
              {% endif %}
            </div>
          </div>

          <div class="text-end">
            {% if not locked %}
              <div class="btn-group" role="group">
                <button class="btn btn-sm btn-outline-secondary btn-edit-co"
                        data-edit-url="{% url 'edit_co' course.id co.id %}"
                        data-code="{{ co.code }}"
                        data-description="{{ co.description|escapejs }}"
                        data-blooms="{{ co.bloom_levels|join:"," }}"
                        data-bs-toggle="modal" data-bs-target="#coModal">
                  <i class="bi bi-pencil-square"></i>
                </button>
                <form method="post" action="{% url 'delete_co' course.id co.id %}" class="d-inline ms-1"
                      onsubmit="return confirm('Delete {{ co.code }}?')">
                  {% csrf_token %}
                  <button class="btn btn-sm btn-outline-danger" title="Delete"><i class="bi bi-trash"></i></button>
                </form>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% empty %}
    <div class="col-12">
      <div class="card">
        <div class="card-body text-center text-muted py-4">No course outcomes defined yet.</div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- CO Modal (Add / Edit) -->
  {% if not locked %}
  <div class="modal fade" id="coModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <form id="coForm" method="post" action="">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title" id="coModalTitle">Add Course Outcome</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">CO Code</label>
              <input type="text" name="code" id="coCode" class="form-control" required>
              <div class="form-text">Suggested: <code>{{ suggested_code }}</code></div>
            </div>
            <div class="mb-3">
              <label class="form-label">Description <span class="text-danger">*</span></label>
              <textarea name="description" id="coDescription" class="form-control" rows="3" required></textarea>
            </div>
            <div class="mb-2">
              <label class="form-label">Bloom Levels (select one or more)</label>
              <div class="d-flex gap-2 flex-wrap" id="bloomCards">
                {% for b in bloom_choices %}
                  <label class="card bloom-card p-2 text-center" data-value="{{ b }}" style="min-width:110px; cursor:pointer;">
                    <input type="checkbox" name="bloom_levels" value="{{ b }}" class="form-check-input bloom-checkbox d-none">
                    <div class="fw-semibold">L{{ forloop.counter }}</div>
                    <div class="small text-muted">{{ b }}</div>
                  </label>
                {% endfor %}
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary" id="coSubmitBtn">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% endif %}

</div>
</div>

{% if not locked %}
<style>
  .bloom-card { border:1px solid #e9ecef; border-radius:6px; padding:10px; }
  .bloom-card.active { border-color: #0d6efd; background-color: #e9f2ff; }
</style>
<script>
  (function(){
    const suggested = "{{ suggested_code }}";
    const coForm = document.getElementById('coForm');
    const modalTitle = document.getElementById('coModalTitle');
    const coCode = document.getElementById('coCode');
    const coDescription = document.getElementById('coDescription');
    const bloomCards = document.querySelectorAll('.bloom-card');
    const bloomCheckboxes = document.querySelectorAll('.bloom-checkbox');
    const btnAdd = document.getElementById('btnAddCO');

    function clearSelections(){
      bloomCheckboxes.forEach(cb => cb.checked = false);
      bloomCards.forEach(c => c.classList.remove('active'));
    }
    function setSelections(values){
      clearSelections();
      if(!values) return;
      const arr = values.split(',').map(s => s.trim()).filter(Boolean);
      bloomCheckboxes.forEach(cb => {
        if(arr.includes(cb.value)){
          cb.checked = true;
          cb.closest('.bloom-card').classList.add('active');
        }
      });
    }

    // make cards toggle the hidden checkbox
    bloomCards.forEach(card => {
      card.addEventListener('click', function(e){
        const cb = this.querySelector('.bloom-checkbox');
        cb.checked = !cb.checked;
        this.classList.toggle('active', cb.checked);
      });
    });

    // Add CO button handler — prefill suggested values
    if(btnAdd){
      btnAdd.addEventListener('click', function(){
        modalTitle.textContent = 'Add Course Outcome';
        coForm.action = "{% url 'create_co' course.id %}";
        coCode.value = suggested;
        coDescription.value = '';
        clearSelections();
        document.getElementById('coSubmitBtn').textContent = 'Create';
      });
    }

    // Edit buttons — populate modal from data attributes
    document.querySelectorAll('.btn-edit-co').forEach(btn => {
      btn.addEventListener('click', function(){
        modalTitle.textContent = 'Edit Course Outcome';
        coForm.action = this.dataset.editUrl;
        coCode.value = this.dataset.code || '';
        coDescription.value = this.dataset.description || '';
        setSelections(this.dataset.blooms || '');
        document.getElementById('coSubmitBtn').textContent = 'Update';
      });
    });

    // Reset modal when closed
    const coModalEl = document.getElementById('coModal');
    if(coModalEl){
      coModalEl.addEventListener('hidden.bs.modal', function () {
        coForm.action = '';
        coCode.value = '';
        coDescription.value = '';
        clearSelections();
      });
    }
  })();
</script>
{% endif %}

{% endblock %}
