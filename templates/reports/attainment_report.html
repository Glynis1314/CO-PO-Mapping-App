{% extends "base.html" %}
{% block title %}Attainment Report — DBIT Prototype{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-3">{% include "components/sidebar_hod.html" %}</div>
  <div class="col-md-9">
    <h3>Attainment Report</h3>

    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <form method="GET" action="{% url 'attainment_report' %}" class="row">
          <div class="col-md-4">
            <label class="form-label">Academic Year / Semester</label>
            <select name="academic_year" class="form-select">
              {% for year in academic_years %}
                <option value="{{ year.id }}" {% if selected_year == year.id|slugify %}selected{% endif %}>
                  {{ year.name }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">Subject</label>
            <select name="subject" class="form-select">
              {% for subject in subjects %}
                <option value="{{ subject.id }}" {% if selected_subject == subject.id|slugify %}selected{% endif %}>
                  {{ subject.code }} — {{ subject.name }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-4 align-self-end">
            <button type="submit" class="btn btn-primary">Generate Report</button>
          </div>
        </form>
      </div>
    </div>

    {% if co_results or po_results %}
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <h6>Course Outcome (CO) Attainment</h6>
        <table class="table table-sm">
          <thead><tr><th>CO Code</th><th>Attainment %</th><th>Status</th></tr></thead>
          <tbody>
            {% for co in co_results %}
            <tr>
              <td>{{ co.course_outcome.code }}</td>
              <td>{{ co.attainment_percentage }}%</td>
              <td>
                {% if co.attainment_level == 3 %}
                  <span class="badge bg-success">Target Met</span>
                {% elif co.attainment_level == 2 %}
                  <span class="badge bg-warning">Satisfactory</span>
                {% else %}
                  <span class="badge bg-danger">Gap Identified</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

        <hr>
        <h6>Programme Outcome (PO) Attainment</h6>
        <table class="table table-sm">
          <thead><tr><th>PO Code</th><th>Attainment %</th><th>Level</th></tr></thead>
          <tbody>
            {% for po in po_results %}
            <tr>
              <td>{{ po.program_outcome.code }}</td>
              <td>{{ po.attainment_percentage }}%</td>
              <td>Level {{ po.attainment_level }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% else %}
    <div class="alert alert-info">Select a year and subject to view the real-time attainment report.</div>
    {% endif %}

    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary">Download PDF Report</button>
      <a href="{% url 'gap_analysis' %}" class="btn btn-outline-primary">Open Gap Analysis [cite: 261]</a>
    </div>
  </div>
</div>
{% endblock %}